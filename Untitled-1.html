<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <h1>Sistema de Nómina</h1>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Añadimos fuente de Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0011ff;
            --primary-hover: #8c00ff;
            --secondary-color: #ff0000;
            --text-color: #000000;
            --light-text: #ff0000;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #00ffaa;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #72d0e7;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: rgb(127, 241, 245);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem 2rem;
        }

        .card {
            background-color: rgb(182, 244, 255);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        h1 {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        h2 {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
        }

        .buttons {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--primary-color);
            color: rgb(255, 255, 255);
        }

        button i {
            margin-right: 0.5rem;
        }

        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        button.secondary {
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        button.secondary:hover {
            background-color: var(--secondary-color);
        }

        button.success {
            background-color: var(--success-color);
        }

        button.success:hover {
            background-color: #0da271;
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.danger:hover {
            background-color: #dc2626;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
        }

        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        tbody tr:hover {
            background-color: #f1f5f9;
        }

        .form-container {
            display: none;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            background-color: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.25rem;
        }

        .form-group {
            margin-bottom: 0.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        input {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border-color);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-buttons button {
            padding: 0.375rem 0.75rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>Tabla con los salarios a pagar a los colaboradores de la mecanica </h1>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="buttons">
                <button onclick="showAddForm()"><i class="fas fa-plus"></i> Agregar Empleado</button>
                <button class="success" onclick="printPayroll()"><i class="fas fa-print"></i> Imprimir</button>
                <button onclick="openPayrollPage()"><i class="fas fa-money-bill-wave"></i> Enviar Sueldos</button>
                <button onclick="Retornar()"><i class="fas fa-door-open"></i> Serrar Secion </button>

            </div>

            <div id="formContainer" class="form-container">
                <h2 id="formTitle">Agregar Empleado</h2>
                <form id="employeeForm" onsubmit="handleSubmit(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Apellidos y Nombres:</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Correo:</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="position">Cargo:</label>
                            <input type="text" id="position" required>
                        </div>
                        <div class="form-group">
                            <label for="startDate">Fecha Ingreso:</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="currentDate">Fecha Actual:</label>
                            <input type="date" id="currentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="overtime">Horas Extras:</label>
                            <input type="number" id="overtime" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="salary">Sueldo:</label>
                            <input type="number" id="salary" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="bonus">Bonificación:</label>
                            <input type="number" id="bonus" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="transport">Transporte:</label>
                            <input type="number" id="transport" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="food">Alimentación:</label>
                            <input type="number" id="food" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="iessLoan">Préstamos IESS:</label>
                            <input type="number" id="iessLoan" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="commissary">Comisariato:</label>
                            <input type="number" id="commissary" required min="0">
                        </div>
                    </div>

                    <div class="form-footer">
                        <button type="button" class="secondary" onclick="hideForm()">Cancelar</button>
                        <button type="submit" id="submitBtn" class="success">Guardar</button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <table id="payrollTable">
                    <thead>
                        <tr>
                            <th rowspan="2">N°</th>
                            <th rowspan="2">Apellidos y Nombres</th>
                            <th rowspan="2">Correo</th>
                            <th rowspan="2">Cargo</th>
                            <th rowspan="2">Fecha Ingreso</th>
                            <th rowspan="2">Fecha Actual</th>
                            <th rowspan="2">Horas extras</th>
                            <th rowspan="2">Líquido a Pagar</th>
                            <th colspan="7">Ingresos/Bonificaciones</th>
                            <th colspan="5">Egresos/Descuentos</th>
                            <th rowspan="2">Total Ingresos</th>
                            <th rowspan="2">Total Egresos</th>
                            <th rowspan="2">Líquido a Pagar</th>
                            <th rowspan="2">Acciones</th>
                        </tr>
                        <tr>
                            <th>Sueldo</th>
                            <th>Bonificación</th>
                            <th>Transporte</th>
                            <th>Alimentación</th>
                            <th>Décimo Tercero</th>
                            <th>Décimo Cuarto</th>
                            <th>Fondos de Reserva</th>
                            <th>IESS (9.45%)</th>
                            <th>Préstamos IESS</th>
                            <th>Impuesto Renta</th>
                            <th>Seguro Privado</th>
                            <th>Comisariato</th>
                        </tr>
                    </thead>
                    <tbody id="payrollBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let editingId = null;
        let employees = [
            {
                id: 1,
                name: "Juan Pérez",
                email: "juan@example.com",
                position: "mecanico",
                startDate: "2024-01-15",
                currentDate: new Date().toISOString().split('T')[0],
                overtime: 10,
                salary: 1200,
                bonus: 100,
                transport: 50,
                food: 80,
                iessLoan: 50,
                commissary: 30
            },
            {
                id: 2,
                name: "María López",
                email: "maria@example.com",
                position: "limpieza",
                startDate: "2024-02-01",
                currentDate: new Date().toISOString().split('T')[0],
                overtime: 8,
                salary: 1100,
                bonus: 90,
                transport: 50,
                food: 80,
                iessLoan: 0,
                commissary: 25
            },
            {
                id: 3,
                name: "Carlos Ruiz",
                email: "carlos@example.com",
                position: "Analista",
                startDate: "2024-01-20",
                currentDate: new Date().toISOString().split('T')[0],
                overtime: 12,
                salary: 1300,
                bonus: 110,
                transport: 50,
                food: 80,
                iessLoan: 100,
                commissary: 40
            },
            {
                id: 4,
                name: "Ana García",
                email: "ana@example.com",
                position: "Gerente",
                startDate: "2024-01-10",
                currentDate: new Date().toISOString().split('T')[0],
                overtime: 15,
                salary: 1500,
                bonus: 150,
                transport: 50,
                food: 80,
                iessLoan: 200,
                commissary: 50
            }
        ];

        function calculateBenefits(salary, currentDateStr) {
            // Convertir la fecha ingresada de string a objeto Date
            const currentDate = new Date(currentDateStr);
            const month = currentDate.getMonth() + 1; // +1 porque getMonth() devuelve 0-11
            
            // Décimo Tercero - se paga en Diciembre (mes 12)
            const d13 = month === 12 ? salary : 0;
            
            // Décimo Cuarto - se paga en Agosto (mes 8)
            const d14 = month === 8 ? salary / 12 * 12 : 0;
            
            // Fondos de Reserva (8.33%)
            const reserveFunds = salary * 0.0833;
            
            return { d13, d14, reserveFunds };
        }

        function calculateDeductions(salary) {
            const iess = salary * 0.0945;
            const incomeTax = salary > 11310 ? salary * 0.05 : 0;
            const privateInsurance = salary * 0.01;
            return { iess, incomeTax, privateInsurance };
        }

        function calculateOvertime(salary, hours) {
            const hourlyRate = salary / 240;
            const overtimeRate = hourlyRate * 1.5;
            return overtimeRate * hours;
        }

        function calculateTotals(employee) {
            const benefits = calculateBenefits(employee.salary, employee.currentDate);
            const deductions = calculateDeductions(employee.salary);
            const overtimePay = calculateOvertime(employee.salary, employee.overtime);

            const totalIncome = 
                employee.salary +
                employee.bonus +
                employee.transport +
                employee.food +
                benefits.d13 +
                benefits.d14 +
                benefits.reserveFunds +
                overtimePay;

            const totalDeductions =
                deductions.iess +
                employee.iessLoan +
                deductions.incomeTax +
                deductions.privateInsurance +
                employee.commissary;

            return {
                benefits,
                deductions,
                overtimePay,
                totalIncome,
                totalDeductions,
                netPay: totalIncome - totalDeductions
            };
        }

        function renderTable() {
            const tbody = document.getElementById('payrollBody');
            tbody.innerHTML = '';
            
            employees.forEach((emp, index) => {
                const calculations = calculateTotals(emp);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${emp.name}</td>
                    <td>${emp.email}</td>
                    <td>${emp.position}</td>
                    <td>${emp.startDate}</td>
                    <td>${emp.currentDate}</td>
                    <td>${emp.overtime}</td>
                    <td><strong>$${calculations.netPay.toFixed(2)}</strong></td>
                    <td>$${emp.salary.toFixed(2)}</td>
                    <td>$${emp.bonus.toFixed(2)}</td>
                    <td>$${emp.transport.toFixed(2)}</td>
                    <td>$${emp.food.toFixed(2)}</td>
                    <td>$${calculations.benefits.d13.toFixed(2)}</td>
                    <td>$${calculations.benefits.d14.toFixed(2)}</td>
                    <td>$${calculations.benefits.reserveFunds.toFixed(2)}</td>
                    <td>$${calculations.deductions.iess.toFixed(2)}</td>
                    <td>$${emp.iessLoan.toFixed(2)}</td>
                    <td>$${calculations.deductions.incomeTax.toFixed(2)}</td>
                    <td>$${calculations.deductions.privateInsurance.toFixed(2)}</td>
                    <td>$${emp.commissary.toFixed(2)}</td>
                    <td><strong>$${calculations.totalIncome.toFixed(2)}</strong></td>
                    <td><strong>$${calculations.totalDeductions.toFixed(2)}</strong></td>
                    <td><strong>$${calculations.netPay.toFixed(2)}</strong></td>
                    <td class="action-buttons">
                        <button onclick="editEmployee(${emp.id})"><i class="fas fa-edit"></i></button>
                        <button class="danger" onclick="deleteEmployee(${emp.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            // Store employees data in localStorage for the payment page
            localStorage.setItem('employeesData', JSON.stringify(employees));
        }

        function showAddForm() {
            document.getElementById('formContainer').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Agregar Empleado';
            document.getElementById('employeeForm').reset();
            document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Guardar';
            editingId = null;
        }

        function hideForm() {
            document.getElementById('formContainer').style.display = 'none';
            editingId = null;
        }

        function handleSubmit(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                position: document.getElementById('position').value,
                startDate: document.getElementById('startDate').value,
                currentDate: document.getElementById('currentDate').value,
                overtime: Number(document.getElementById('overtime').value),
                salary: Number(document.getElementById('salary').value),
                bonus: Number(document.getElementById('bonus').value),
                transport: Number(document.getElementById('transport').value),
                food: Number(document.getElementById('food').value),
                iessLoan: Number(document.getElementById('iessLoan').value),
                commissary: Number(document.getElementById('commissary').value)
            };

            if (editingId) {
                const index = employees.findIndex(emp => emp.id === editingId);
                employees[index] = { ...employees[index], ...formData };
            } else {
                formData.id = employees.length + 1;
                employees.push(formData);
            }

            hideForm();
            renderTable();
        }

        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;

            editingId = id;
            document.getElementById('formTitle').textContent = 'Editar Empleado';
            document.getElementById('formContainer').style.display = 'block';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar';

            document.getElementById('name').value = employee.name;
            document.getElementById('email').value = employee.email;
            document.getElementById('position').value = employee.position;
            document.getElementById('startDate').value = employee.startDate;
            document.getElementById('currentDate').value = employee.currentDate;
            document.getElementById('overtime').value = employee.overtime;
            document.getElementById('salary').value = employee.salary;
            document.getElementById('bonus').value = employee.bonus;
            document.getElementById('transport').value = employee.transport;
            document.getElementById('food').value = employee.food;
            document.getElementById('iessLoan').value = employee.iessLoan;
            document.getElementById('commissary').value = employee.commissary;
        }

        function deleteEmployee(id) {
            if (confirm('¿Está seguro de eliminar este empleado?')) {
                employees = employees.filter(emp => emp.id !== id);
                renderTable();
            }
        }

        function openPayrollPage() {
            window.location.href = 'payments.html';
        }

        function printPayroll() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const now = new Date();
            const header = `Nómina de Salarios - ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
            
            // Logo o título
            doc.setFontSize(18);
            doc.setTextColor(37, 99, 235); // Color primario
            doc.text("SISTEMA DE NÓMINA", 105, 20, { align: 'center' });
            
            // Subtítulo
            doc.setFontSize(12);
            doc.setTextColor(31, 41, 55); // Color texto
            doc.text(header, 105, 30, { align: 'center' });
            
            // Fecha
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128); // Color texto claro
            doc.text(`Se deben relizar los siguiente pagos, siendo hoy  ${now.getDate()} a las ${now.getHours()} horas y ${now.getMinutes()} minutos`, 105, 40, { align: 'center' });
            
            // Línea separadora
            doc.setDrawColor(229, 231, 235); // Color borde
            doc.line(14, 45, 196, 45);
            
            const tableData = employees.map((emp, index) => {
                const calculations = calculateTotals(emp);
                return [
                    index + 1,
                    emp.name,
                    emp.position,
                    `$${emp.salary.toFixed(2)}`,
                    `$${calculations.totalIncome.toFixed(2)}`,
                    `$${calculations.totalDeductions.toFixed(2)}`,
                    `$${calculations.netPay.toFixed(2)}`
                ];
            });
            
            // Tabla mejorada
            doc.autoTable({
                head: [['N°', 'Nombre', 'Cargo', 'Sueldo Base', 'Total Ingresos', 'Total Descuentos', 'Líquido a Pagar']],
                body: tableData,
                startY: 50,
                headStyles: {
                    fillColor: [37, 99, 235],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [249, 250, 251]
                },
                margin: { top: 50 }
            });
            
            // Añadir pie de página
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.text("* Este documento debe ser enviado al contador o genrente financiero para que se apruebe el pago ", 14, finalY);
            doc.save(`nomina-${now.getTime()}.pdf`);
        }
function Retornar(){
    window.location.href = "login.html";

}
        // Inicializar la tabla
        window.onload = function() {
            renderTable();
        };
    </script>
</body>
</html>